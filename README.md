# AutoCAD 聚合線長度統計程式使用說明

## 功能概述
此程式能夠自動統計AutoCAD圖面中聚合線的長度，並輸出到CSV檔案（可使用Excel開啟）。

## 主要功能
1. **圖層選擇**: 可以複選多個圖層來統計聚合線
2. **CSV輸出**: 將統計結果輸出到CSV檔案，可用Excel直接開啟
3. **圖塊名稱映射**: 重新定義圖塊名稱以便在輸出檔案中顯示
4. **分段統計**: 每個彎折點分為一段，分別計算長度
5. **自動尋找連接圖塊**: 自動尋找聚合線起終點連接的圖塊
6. **引線文字擷取**: 自動擷取圖塊附近的引線文字

## 使用方法

### 1. 啟動程式
在AutoCAD命令列輸入：
- `PLSTATS` 或
- `聚合線統計`

### 2. 操作介面說明

#### 選擇聚合線圖層
- 勾選您要統計的聚合線所在圖層
- 可以複選多個圖層

#### 檔案設定
- **Excel檔案名稱**: 輸入要儲存的檔案名稱（預設：聚合線統計.xlsx）
- **輸出路徑**: 選擇檔案要儲存的位置（預設：桌面）
- 點擊「瀏覽...」按鈕可以選擇不同的儲存位置
- **注意**: 實際輸出將自動轉換為CSV格式，可用Excel直接開啟

#### 圖塊名稱映射表格
- **原始圖塊名稱**: 輸入在AutoCAD中的圖塊名稱
- **新圖塊名稱**: 輸入您想要在輸出檔案中顯示的名稱
- 可以新增多行來設定多個圖塊的名稱映射
- 如果沒有設定映射，將使用原始圖塊名稱

### 3. 開始統計
點擊「開始統計」按鈕執行分析

## 輸出格式

### 檔案格式
- **主要格式**: CSV檔案（Comma-Separated Values）
- **相容性**: 可用Microsoft Excel、Google Sheets等試算表軟體開啟
- **編碼**: UTF-8 with BOM，確保中文正確顯示

### 欄位說明
1. **起點圖塊**: 聚合線起點連接的圖塊名稱
2. **終點圖塊**: 聚合線終點連接的圖塊名稱  
3. **引線文字**: 連接圖塊的引線標注文字
4. **第N段長度**: 聚合線各段的長度（每個彎折點分為一段）
5. **總長度**: 整條聚合線的總長度

### 範例輸出"起點圖塊","終點圖塊","引線文字","第1段長度","第2段長度","第3段長度","總長度"
"MH-01","MH-02","污水",15.50,12.30,,27.80
"MH-02","MH-03","雨水",20.15,,,20.15
## 注意事項

### 圖塊連接偵測
- 程式會在聚合線起終點附近1.0單位範圍內尋找圖塊
- 確保圖塊與聚合線端點距離在容差範圍內

### 引線文字偵測
- 程式會在圖塊周圍10.0單位範圍內尋找文字物件
- 支援DBText和MText兩種文字類型
- 優先顯示起點圖塊的文字，若無則顯示終點圖塊的文字

### 聚合線分段規則
- 每個頂點（彎折點）之間為一段
- 支援直線段和弧線段的長度計算
- 弧線段會自動計算弧長

### 圖層選擇
- 至少需要選擇一個圖層
- 只會統計選擇圖層中的聚合線物件

### CSV檔案開啟
- 可以直接用Excel開啟CSV檔案
- 如果中文顯示有問題，請在Excel中選擇「資料」→「從文字/CSV」→「檔案來源」選擇「UTF-8」

## 故障排除

### 沒有找到聚合線
- 檢查是否選擇了正確的圖層
- 確認圖層中確實有聚合線物件
- 檢查聚合線是否在模型空間中

### 圖塊名稱顯示不正確
- 檢查圖塊名稱映射表格設定
- 確認原始圖塊名稱輸入正確

### 無法開啟檔案
- 檢查CSV檔案是否被其他程式占用
- 確認輸出路徑存在且有寫入權限
- 檢查檔案名稱是否包含非法字元

### 中文顯示問題
- CSV檔案使用UTF-8編碼儲存
- 在Excel中開啟時，如果中文顯示異常，請使用「資料」→「從文字/CSV」功能開啟

## 技術規格

### 系統需求
- AutoCAD 2024或更新版本
- .NET 8.0 Runtime
- Microsoft Excel或其他試算表軟體（用於開啟結果檔案）

### 使用的技術
- **.NET 8.0**: 框架版本
- **AutoCAD.NET 25.0.1**: AutoCAD API
- **純文字CSV格式**: 無外部套件相依性，確保最大相容性

## 版本更新記錄

### v1.2 (推薦版本)
- 改用CSV格式輸出，解決Excel套件相依性問題
- 提升程式穩定性和相容性
- 簡化部署，無需額外套件
- 支援UTF-8編碼，確保中文正確顯示

### v1.1
- 將Excel處理套件從ClosedXML更換為EPPlus
- 修正.NET 8環境下的相依性問題

### v1.0
- 初始版本
- 基本聚合線統計功能

## 優勢特色

### ?? **高穩定性**
- 使用標準CSV格式，無外部套件相依性
- 避免Excel套件載入問題

### ?? **廣泛相容**
- CSV檔案可用任何試算表軟體開啟
- 支援Excel、Google Sheets、LibreOffice等

### ?? **易於部署**
- 無需安裝額外套件
- 減少版本衝突問題

### ?? **功能完整**
- 保持所有原有統計功能
- 支援中文編碼
- 自動格式化數據

## 技術支援
如有問題或建議，請聯繫開發團隊。